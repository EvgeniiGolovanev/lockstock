name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  migrate-prod:
    name: Apply Production DB Migrations
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Validate required Supabase secrets
        run: |
          test -n "$SUPABASE_ACCESS_TOKEN" || (echo "Missing SUPABASE_ACCESS_TOKEN secret." && exit 1)
          test -n "$SUPABASE_PROJECT_REF" || (echo "Missing SUPABASE_PROJECT_REF secret." && exit 1)
          test -n "$SUPABASE_DB_PASSWORD" || (echo "Missing SUPABASE_DB_PASSWORD secret." && exit 1)

      - name: Link project
        run: supabase link --project-ref "$SUPABASE_PROJECT_REF" --password "$SUPABASE_DB_PASSWORD"

      - name: Apply migrations to linked project
        run: supabase db push --linked

  deploy-prod:
    name: Deploy Production App
    needs: migrate-prod
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate required Vercel secrets
        run: |
          test -n "$VERCEL_TOKEN" || (echo "Missing VERCEL_TOKEN secret." && exit 1)
          test -n "$VERCEL_ORG_ID" || (echo "Missing VERCEL_ORG_ID secret." && exit 1)
          test -n "$VERCEL_PROJECT_ID" || (echo "Missing VERCEL_PROJECT_ID secret." && exit 1)

      - name: Pull Vercel environment config
        run: npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN"

      - name: Build app for Vercel
        run: npx vercel build --prod --token="$VERCEL_TOKEN"

      - name: Deploy prebuilt app to Vercel
        run: npx vercel deploy --prebuilt --prod --token="$VERCEL_TOKEN"
